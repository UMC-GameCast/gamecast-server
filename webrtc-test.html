<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameCast WebRTC í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .section h3 {
            margin-top: 0;
            color: #555;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #666;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.waiting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        #log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .video-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .video-box {
            flex: 1;
            min-width: 300px;
        }
        video {
            width: 100%;
            height: 200px;
            background-color: #000;
            border-radius: 8px;
        }
        .room-info {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .participants {
            background-color: #f0f8f0;
            padding: 15px;
            border-radius: 8px;
        }
        .participant {
            padding: 8px;
            margin: 5px 0;
            background-color: white;
            border-radius: 4px;
            border-left: 4px solid #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® GameCast WebRTC í…ŒìŠ¤íŠ¸</h1>
        
        <!-- ì—°ê²° ìƒíƒœ -->
        <div id="connectionStatus" class="status disconnected">
            ğŸ”´ ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•ŠìŒ
        </div>

        <!-- 1. ë°© ìƒì„± ì„¹ì…˜ -->
        <div class="section">
            <h3>ğŸ“‹ 1. ë°© ìƒì„±</h3>
            <div class="form-group">
                <label for="roomName">ë°© ì´ë¦„:</label>
                <input type="text" id="roomName" placeholder="í…ŒìŠ¤íŠ¸ ë°©" value="WebRTC í…ŒìŠ¤íŠ¸ ë°©">
            </div>
            <div class="form-group">
                <label for="hostNickname">ë°©ì¥ ë‹‰ë„¤ì„:</label>
                <input type="text" id="hostNickname" placeholder="ë°©ì¥ ë‹‰ë„¤ì„" value="í…ŒìŠ¤íŠ¸ë°©ì¥">
            </div>
            <div class="form-group">
                <label for="maxCapacity">ìµœëŒ€ ì¸ì›:</label>
                <select id="maxCapacity">
                    <option value="2">2ëª…</option>
                    <option value="3">3ëª…</option>
                    <option value="4" selected>4ëª…</option>
                    <option value="5">5ëª…</option>
                </select>
            </div>
            <button onclick="createRoom()">ë°© ìƒì„±</button>
        </div>

        <!-- 2. ë°© ì°¸ì—¬ ì„¹ì…˜ -->
        <div class="section">
            <h3>ğŸšª 2. ë°© ì°¸ì—¬</h3>
            <div class="form-group">
                <label for="joinRoomCode">ë°© ì½”ë“œ:</label>
                <input type="text" id="joinRoomCode" placeholder="6ìë¦¬ ì½”ë“œ ì…ë ¥" maxlength="6">
            </div>
            <div class="form-group">
                <label for="guestNickname">ë‹‰ë„¤ì„:</label>
                <input type="text" id="guestNickname" placeholder="ê²ŒìŠ¤íŠ¸ ë‹‰ë„¤ì„" value="í…ŒìŠ¤íŠ¸ê²ŒìŠ¤íŠ¸">
            </div>
            <button onclick="joinRoom()">ë°© ì°¸ì—¬</button>
            <button onclick="leaveRoom()" disabled id="leaveBtn">ë°© ë‚˜ê°€ê¸°</button>
        </div>

        <!-- 3. ë°© ì •ë³´ -->
        <div id="roomInfo" class="room-info" style="display: none;">
            <h3>ğŸ  ë°© ì •ë³´</h3>
            <div id="roomDetails"></div>
        </div>

        <!-- 4. ì°¸ì—¬ì ëª©ë¡ -->
        <div id="participantsInfo" class="participants" style="display: none;">
            <h3>ğŸ‘¥ ì°¸ì—¬ì ëª©ë¡</h3>
            <div id="participantsList"></div>
        </div>

        <!-- 5. WebRTC í…ŒìŠ¤íŠ¸ -->
        <div class="section">
            <h3>ğŸ¥ 3. WebRTC ì—°ê²° í…ŒìŠ¤íŠ¸</h3>
            <button onclick="startLocalVideo()" id="startVideoBtn">ë¹„ë””ì˜¤ ì‹œì‘</button>
            <button onclick="stopLocalVideo()" disabled id="stopVideoBtn">ë¹„ë””ì˜¤ ì¤‘ì§€</button>
            <button onclick="connectToRoom()" disabled id="connectBtn">ë°©ì— WebRTC ì—°ê²°</button>
            
            <div class="video-container">
                <div class="video-box">
                    <h4>ë‚´ í™”ë©´</h4>
                    <video id="localVideo" autoplay muted></video>
                </div>
                <div class="video-box">
                    <h4>ìƒëŒ€ë°© í™”ë©´</h4>
                    <video id="remoteVideo" autoplay></video>
                </div>
            </div>
        </div>

        <!-- 6. ë¡œê·¸ -->
        <div class="section">
            <h3>ğŸ“ ë¡œê·¸</h3>
            <div id="log"></div>
            <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = null;
        let localStream = null;
        let peerConnection = null;
        let currentRoomCode = null;
        let sessionId = null;
        let guestUserId = null;

        // UUID ìƒì„±
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // ë¡œê·¸ í•¨ìˆ˜
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // ì„œë²„ ì—°ê²°
        function connectToServer() {
            socket = io('http://localhost:8889');
            
            socket.on('connect', () => {
                log('âœ… ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
                updateConnectionStatus(true);
            });

            socket.on('disconnect', () => {
                log('âŒ ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
                updateConnectionStatus(false);
            });

            socket.on('room-joined', (data) => {
                log(`ğŸ‰ ë°© ì°¸ì—¬ ì„±ê³µ: ${JSON.stringify(data)}`);
                currentRoomCode = data.roomCode;
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('leaveBtn').disabled = false;
                updateRoomInfo(data);
            });

            socket.on('user-joined', (data) => {
                log(`ğŸ‘‹ ìƒˆ ì‚¬ìš©ì ì°¸ì—¬: ${data.nickname}`);
                updateParticipants(data.participants);
            });

            socket.on('user-left', (data) => {
                log(`ğŸ‘‹ ì‚¬ìš©ì ë‚˜ê°: ${data.nickname}`);
                updateParticipants(data.participants);
            });

            socket.on('offer', (data) => {
                log('ğŸ“ Offer ìˆ˜ì‹ ');
                handleReceiveOffer(data);
            });

            socket.on('answer', (data) => {
                log('ğŸ“ Answer ìˆ˜ì‹ ');
                handleReceiveAnswer(data);
            });

            socket.on('ice-candidate', (data) => {
                log('ğŸ§Š ICE Candidate ìˆ˜ì‹ ');
                handleReceiveIceCandidate(data);
            });

            socket.on('error', (error) => {
                log(`âŒ ì—ëŸ¬: ${error.message}`);
            });
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.className = 'status connected';
                statusElement.textContent = 'ğŸŸ¢ ì„œë²„ì— ì—°ê²°ë¨';
            } else {
                statusElement.className = 'status disconnected';
                statusElement.textContent = 'ğŸ”´ ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•ŠìŒ';
            }
        }

        // ë°© ìƒì„±
        async function createRoom() {
            if (!sessionId) sessionId = generateUUID();
            
            const roomData = {
                room_name: document.getElementById('roomName').value || 'í…ŒìŠ¤íŠ¸ ë°©',
                host_session_id: sessionId,
                host_nickname: document.getElementById('hostNickname').value || 'í…ŒìŠ¤íŠ¸ë°©ì¥',
                max_capacity: parseInt(document.getElementById('maxCapacity').value)
            };

            try {
                log('ğŸ—ï¸ ë°© ìƒì„± ì¤‘...');
                const response = await fetch('http://localhost:8889/api/rooms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(roomData)
                });

                const result = await response.json();
                
                if (result.resultType === 'SUCCESS') {
                    log(`âœ… ë°© ìƒì„± ì„±ê³µ! ì½”ë“œ: ${result.success.roomCode}`);
                    document.getElementById('joinRoomCode').value = result.success.roomCode;
                    guestUserId = result.success.hostGuestId;
                    
                    // ìë™ìœ¼ë¡œ WebSocket ë°© ì°¸ì—¬
                    if (socket) {
                        joinWebSocketRoom(result.success.roomCode, guestUserId, roomData.host_nickname);
                    }
                } else {
                    log(`âŒ ë°© ìƒì„± ì‹¤íŒ¨: ${result.error.reason}`);
                }
            } catch (error) {
                log(`âŒ ë°© ìƒì„± ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // ë°© ì°¸ì—¬
        async function joinRoom() {
            const roomCode = document.getElementById('joinRoomCode').value;
            if (!roomCode) {
                alert('ë°© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!sessionId) sessionId = generateUUID();
            
            const joinData = {
                room_code: roomCode,
                session_id: sessionId,
                nickname: document.getElementById('guestNickname').value || 'í…ŒìŠ¤íŠ¸ê²ŒìŠ¤íŠ¸'
            };

            try {
                log('ğŸšª ë°© ì°¸ì—¬ ì¤‘...');
                const response = await fetch('http://localhost:8889/api/rooms/join', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(joinData)
                });

                const result = await response.json();
                
                if (result.resultType === 'SUCCESS') {
                    log(`âœ… ë°© ì°¸ì—¬ ì„±ê³µ!`);
                    guestUserId = result.success.guestUserId;
                    
                    // WebSocket ë°© ì°¸ì—¬
                    if (socket) {
                        joinWebSocketRoom(roomCode, guestUserId, joinData.nickname);
                    }
                } else {
                    log(`âŒ ë°© ì°¸ì—¬ ì‹¤íŒ¨: ${result.error.reason}`);
                }
            } catch (error) {
                log(`âŒ ë°© ì°¸ì—¬ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // WebSocket ë°© ì°¸ì—¬
        function joinWebSocketRoom(roomCode, guestUserId, nickname) {
            if (!socket) {
                log('âŒ ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            socket.emit('join-room', {
                roomCode: roomCode,
                guestUserId: guestUserId,
                nickname: nickname
            });

            log(`ğŸ”Œ WebSocket ë°© ì°¸ì—¬ ìš”ì²­: ${roomCode}`);
        }

        // ë°© ë‚˜ê°€ê¸°
        function leaveRoom() {
            if (socket && currentRoomCode) {
                socket.emit('leave-room', { roomCode: currentRoomCode });
                log('ğŸšª ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.');
                
                currentRoomCode = null;
                guestUserId = null;
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('leaveBtn').disabled = true;
                
                hideRoomInfo();
            }
        }

        // ë¹„ë””ì˜¤ ì‹œì‘
        async function startLocalVideo() {
            try {
                log('ğŸ“¹ ë¡œì»¬ ë¹„ë””ì˜¤ ì‹œì‘...');
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('startVideoBtn').disabled = true;
                document.getElementById('stopVideoBtn').disabled = false;
                
                log('âœ… ë¡œì»¬ ë¹„ë””ì˜¤ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                log(`âŒ ë¹„ë””ì˜¤ ì‹œì‘ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // ë¹„ë””ì˜¤ ì¤‘ì§€
        function stopLocalVideo() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
                document.getElementById('localVideo').srcObject = null;
                document.getElementById('startVideoBtn').disabled = false;
                document.getElementById('stopVideoBtn').disabled = true;
                log('â¹ï¸ ë¡œì»¬ ë¹„ë””ì˜¤ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        // WebRTC ì—°ê²°
        async function connectToRoom() {
            if (!localStream) {
                alert('ë¨¼ì € ë¹„ë””ì˜¤ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”.');
                return;
            }

            log('ğŸ”— WebRTC ì—°ê²° ì‹œì‘...');
            
            // RTCPeerConnection ìƒì„±
            peerConnection = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            });

            // ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ ì¶”ê°€
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // ì›ê²© ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬
            peerConnection.ontrack = (event) => {
                log('ğŸ“º ì›ê²© ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹ ');
                document.getElementById('remoteVideo').srcObject = event.streams[0];
            };

            // ICE Candidate ì²˜ë¦¬
            peerConnection.onicecandidate = (event) => {
                if (event.candidate && socket) {
                    socket.emit('ice-candidate', {
                        candidate: event.candidate,
                        targetSocketId: 'broadcast' // ì‹¤ì œë¡œëŠ” íŠ¹ì • ëŒ€ìƒ ì§€ì •
                    });
                    log('ğŸ§Š ICE Candidate ì „ì†¡');
                }
            };

            // Offer ìƒì„± ë° ì „ì†¡
            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                if (socket) {
                    socket.emit('offer', {
                        offer: offer,
                        targetSocketId: 'broadcast' // ì‹¤ì œë¡œëŠ” íŠ¹ì • ëŒ€ìƒ ì§€ì •
                    });
                    log('ğŸ“ Offer ì „ì†¡');
                }
            } catch (error) {
                log(`âŒ Offer ìƒì„± ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // Offer ìˆ˜ì‹  ì²˜ë¦¬
        async function handleReceiveOffer(data) {
            if (!peerConnection) return;
            
            try {
                await peerConnection.setRemoteDescription(data.offer);
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                if (socket) {
                    socket.emit('answer', {
                        answer: answer,
                        targetSocketId: data.senderSocketId
                    });
                    log('ğŸ“ Answer ì „ì†¡');
                }
            } catch (error) {
                log(`âŒ Offer ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // Answer ìˆ˜ì‹  ì²˜ë¦¬
        async function handleReceiveAnswer(data) {
            if (!peerConnection) return;
            
            try {
                await peerConnection.setRemoteDescription(data.answer);
                log('âœ… Answer ì²˜ë¦¬ ì™„ë£Œ');
            } catch (error) {
                log(`âŒ Answer ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // ICE Candidate ìˆ˜ì‹  ì²˜ë¦¬
        async function handleReceiveIceCandidate(data) {
            if (!peerConnection) return;
            
            try {
                await peerConnection.addIceCandidate(data.candidate);
                log('ğŸ§Š ICE Candidate ì¶”ê°€ ì™„ë£Œ');
            } catch (error) {
                log(`âŒ ICE Candidate ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // ë°© ì •ë³´ ì—…ë°ì´íŠ¸
        function updateRoomInfo(roomData) {
            const roomInfoElement = document.getElementById('roomInfo');
            const roomDetailsElement = document.getElementById('roomDetails');
            
            roomDetailsElement.innerHTML = `
                <p><strong>ë°© ì½”ë“œ:</strong> ${roomData.roomCode}</p>
                <p><strong>ë°© ì´ë¦„:</strong> ${roomData.roomName || 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
                <p><strong>í˜„ì¬ ì¸ì›:</strong> ${roomData.currentCapacity || 1}/${roomData.maxCapacity || 4}</p>
                <p><strong>ìƒíƒœ:</strong> ${roomData.roomState || 'waiting'}</p>
            `;
            
            roomInfoElement.style.display = 'block';
        }

        // ì°¸ì—¬ì ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateParticipants(participants) {
            const participantsElement = document.getElementById('participantsInfo');
            const participantsListElement = document.getElementById('participantsList');
            
            if (participants && participants.length > 0) {
                participantsListElement.innerHTML = participants.map(p => `
                    <div class="participant">
                        <strong>${p.nickname}</strong> (${p.role})
                        <br><small>ì°¸ì—¬ ì‹œê°„: ${new Date(p.joinedAt).toLocaleTimeString()}</small>
                    </div>
                `).join('');
                
                participantsElement.style.display = 'block';
            }
        }

        function hideRoomInfo() {
            document.getElementById('roomInfo').style.display = 'none';
            document.getElementById('participantsInfo').style.display = 'none';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œë²„ ì—°ê²°
        window.onload = function() {
            log('ğŸš€ GameCast WebRTC í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ ì‹œì‘');
            connectToServer();
        };

        // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì •ë¦¬
        window.onbeforeunload = function() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (socket) {
                socket.disconnect();
            }
        };
    </script>
</body>
</html>
