<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® GameCast WebRTC ê³ ê¸‰ í…ŒìŠ¤íŠ¸</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 40px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .section h3 {
            margin-top: 0;
            color: #495057;
            font-size: 1.4em;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
        }
        button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.4);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
            font-size: 16px;
        }
        .status.connected {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 2px solid #28a745;
        }
        .status.disconnected {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 2px solid #dc3545;
        }
        .status.waiting {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            border: 2px solid #ffc107;
        }
        #log {
            background: #2d3748;
            color: #e2e8f0;
            border: 2px solid #4a5568;
            padding: 20px;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            line-height: 1.4;
        }
        .video-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .video-box {
            background: #2d3748;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        .video-box h4 {
            color: white;
            margin: 0 0 15px 0;
            font-size: 1.1em;
        }
        video {
            width: 100%;
            height: 200px;
            background: #1a202c;
            border-radius: 8px;
            border: 2px solid #4a5568;
        }
        .room-info {
            background: linear-gradient(135deg, #e7f3ff, #cce7ff);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #007bff;
        }
        .participants {
            background: linear-gradient(135deg, #f0f8f0, #e6f3e6);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #28a745;
        }
        .participant {
            padding: 12px;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .audio-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .volume-control {
            flex: 1;
        }
        .connection-quality {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .quality-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #dee2e6;
        }
        .quality-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
        }
        .quick-actions {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            .video-container {
                grid-template-columns: 1fr;
            }
            .connection-quality {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® GameCast WebRTC ê³ ê¸‰ í…ŒìŠ¤íŠ¸</h1>
        
        <!-- ì—°ê²° ìƒíƒœ -->
        <div id="connectionStatus" class="status disconnected">
            ğŸ”´ ì„œë²„ì— ì—°ê²° ì¤‘...
        </div>

        <!-- ì„¸ì…˜ ì •ë³´ -->
        <div id="sessionInfo" class="status waiting" style="display: none;">
            <h4>ğŸª ì„¸ì…˜ ì •ë³´</h4>
            <div id="sessionDetails"></div>
            <button onclick="checkSession()" style="margin-top: 10px;">ğŸ” ì„¸ì…˜ í™•ì¸</button>
        </div>

        <div class="main-grid">
            <!-- 1. ë°© ìƒì„± ì„¹ì…˜ -->
            <div class="section">
                <h3>ğŸ“‹ ë°© ìƒì„±</h3>
                <div class="form-group">
                    <label for="roomName">ë°© ì´ë¦„:</label>
                    <input type="text" id="roomName" placeholder="ë©‹ì§„ ë°© ì´ë¦„" value="WebRTC í…ŒìŠ¤íŠ¸ ë°©">
                </div>
                <div class="form-group">
                    <label for="hostNickname">ë°©ì¥ ë‹‰ë„¤ì„:</label>
                    <input type="text" id="hostNickname" placeholder="ë°©ì¥ ë‹‰ë„¤ì„" value="ë°©ì¥">
                </div>
                <div class="form-group">
                    <label for="maxCapacity">ìµœëŒ€ ì¸ì›:</label>
                    <select id="maxCapacity">
                        <option value="2">2ëª…</option>
                        <option value="3">3ëª…</option>
                        <option value="4" selected>4ëª…</option>
                        <option value="5">5ëª…</option>
                    </select>
                </div>
                <button onclick="createRoom()" id="createRoomBtn">ğŸ—ï¸ ë°© ìƒì„±</button>
                <button onclick="getRoomList()" id="getRoomListBtn">ğŸ“‹ ë°© ëª©ë¡ ì¡°íšŒ</button>
            </div>

            <!-- 2. ë°© ì°¸ì—¬ ì„¹ì…˜ -->
            <div class="section">
                <h3>ğŸšª ë°© ì°¸ì—¬</h3>
                <div class="form-group">
                    <label for="joinRoomCode">ë°© ì½”ë“œ:</label>
                    <input type="text" id="joinRoomCode" placeholder="6ìë¦¬ ì½”ë“œ ì…ë ¥" maxlength="6" style="text-transform: uppercase;">
                </div>
                <div class="form-group">
                    <label for="guestNickname">ë‹‰ë„¤ì„:</label>
                    <input type="text" id="guestNickname" placeholder="ê²ŒìŠ¤íŠ¸ ë‹‰ë„¤ì„" value="">
                </div>
                <div class="quick-actions">
                    <button onclick="joinRoom()" id="joinRoomBtn">ğŸšª ë°© ì°¸ì—¬</button>
                    <button onclick="leaveRoom()" disabled id="leaveBtn">ğŸšª ë°© ë‚˜ê°€ê¸°</button>
                    <button onclick="testQuickJoin()" id="quickJoinBtn">âš¡ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸</button>
                </div>
            </div>
        </div>

        <!-- 3. ë°© ì •ë³´ ë° ì°¸ì—¬ì -->
        <div id="roomInfo" class="room-info" style="display: none;">
            <h3>ğŸ  í˜„ì¬ ë°© ì •ë³´</h3>
            <div id="roomDetails"></div>
            <div class="quick-actions">
                <button onclick="refreshRoomInfo()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                <button onclick="copyRoomCode()">ğŸ“‹ ë°© ì½”ë“œ ë³µì‚¬</button>
            </div>
        </div>

        <div id="participantsInfo" class="participants" style="display: none;">
            <h3>ğŸ‘¥ ì°¸ì—¬ì ëª©ë¡ (<span id="participantCount">0</span>ëª…)</h3>
            <div id="participantsList"></div>
        </div>

        <!-- 4. WebRTC ë¯¸ë””ì–´ í…ŒìŠ¤íŠ¸ -->
        <div class="section">
            <h3>ğŸ¥ WebRTC ë¯¸ë””ì–´ ì—°ê²°</h3>
            
            <!-- ë¯¸ë””ì–´ ì œì–´ -->
            <div class="audio-controls">
                <button onclick="startLocalVideo()" id="startVideoBtn">ğŸ“¹ ë¹„ë””ì˜¤ ì‹œì‘</button>
                <button onclick="stopLocalVideo()" disabled id="stopVideoBtn">â¹ï¸ ë¹„ë””ì˜¤ ì¤‘ì§€</button>
                <button onclick="toggleAudio()" id="toggleAudioBtn" disabled>ğŸ¤ ìŒì†Œê±°</button>
                <button onclick="toggleVideo()" id="toggleVideoBtn" disabled>ğŸ“· ë¹„ë””ì˜¤ ë„ê¸°</button>
                <div class="volume-control">
                    <label for="volumeSlider">ìŒëŸ‰: <span id="volumeValue">50</span>%</label>
                    <input type="range" id="volumeSlider" min="0" max="100" value="50" onchange="updateVolume()">
                </div>
            </div>

            <!-- ë¹„ë””ì˜¤ ì˜ì—­ -->
            <div class="video-container">
                <div class="video-box">
                    <h4>ğŸ“¹ ë‚´ í™”ë©´ (ë¡œì»¬)</h4>
                    <video id="localVideo" autoplay muted playsinline></video>
                    <div id="localStats" class="quality-item">
                        <small>í•´ìƒë„: <span id="localResolution">-</span></small>
                    </div>
                </div>
                <div class="video-box">
                    <h4>ğŸ“º ìƒëŒ€ë°© í™”ë©´ (ì›ê²©)</h4>
                    <video id="remoteVideo" autoplay playsinline></video>
                    <div id="remoteStats" class="quality-item">
                        <small>í•´ìƒë„: <span id="remoteResolution">-</span></small>
                    </div>
                </div>
            </div>

            <!-- WebRTC ì—°ê²° ì œì–´ -->
            <div class="quick-actions">
                <button onclick="connectToRoom()" disabled id="connectBtn">ğŸ”— WebRTC ì—°ê²° ì‹œì‘</button>
                <button onclick="disconnectWebRTC()" disabled id="disconnectBtn">ğŸ”Œ ì—°ê²° í•´ì œ</button>
                <button onclick="restartConnection()" disabled id="restartBtn">ğŸ”„ ì—°ê²° ì¬ì‹œì‘</button>
            </div>

            <!-- ì—°ê²° í’ˆì§ˆ ì •ë³´ -->
            <div class="connection-quality">
                <div class="quality-item">
                    <div class="quality-value" id="latency">-</div>
                    <small>ì§€ì—°ì‹œê°„ (ms)</small>
                </div>
                <div class="quality-item">
                    <div class="quality-value" id="packetLoss">-</div>
                    <small>íŒ¨í‚· ì†ì‹¤ (%)</small>
                </div>
                <div class="quality-item">
                    <div class="quality-value" id="bandwidth">-</div>
                    <small>ëŒ€ì—­í­ (kbps)</small>
                </div>
            </div>
        </div>

        <!-- 5. ì‹¤ì‹œê°„ ì±„íŒ… -->
        <div class="section">
            <h3>ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ…</h3>
            
            <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
            <div id="chatMessages" style="height: 300px; overflow-y: auto; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; background: #f8f9fa; margin-bottom: 15px;">
                <div style="text-align: center; color: #666; padding: 20px;">
                    <p>ì±„íŒ…ì´ ì‹œì‘ë˜ë©´ ì—¬ê¸°ì— ë©”ì‹œì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    <p><small>ë°©ì— ì°¸ì—¬í•œ í›„ ì±„íŒ…ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small></p>
                </div>
            </div>
            
            <!-- ì±„íŒ… ì…ë ¥ ì˜ì—­ -->
            <div style="display: flex; gap: 10px;">
                <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                       style="flex: 1; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px;"
                       onkeypress="handleChatKeyPress(event)" disabled>
                <button onclick="sendChatMessage()" id="sendChatBtn" disabled 
                        style="min-width: 100px;">ğŸ’¬ ì „ì†¡</button>
                <button onclick="clearChat()" id="clearChatBtn">ğŸ—‘ï¸ ì§€ìš°ê¸°</button>
            </div>
            
            <!-- ì±„íŒ… ì„¤ì • -->
            <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 8px; font-size: 0.9em;">
                <label style="margin-right: 20px;">
                    <input type="checkbox" id="showTimestamp" checked onchange="toggleTimestamp()"> 
                    ì‹œê°„ í‘œì‹œ
                </label>
                <label style="margin-right: 20px;">
                    <input type="checkbox" id="soundNotification" checked onchange="toggleSoundNotification()"> 
                    ì•Œë¦¼ìŒ
                </label>
                <label>
                    <input type="checkbox" id="autoScroll" checked onchange="toggleAutoScroll()"> 
                    ìë™ ìŠ¤í¬ë¡¤
                </label>
            </div>
        </div>

        <!-- 5. ê³ ê¸‰ í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ -->
        <div class="section">
            <h3>âš¡ ê³ ê¸‰ í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥</h3>
            <div class="quick-actions">
                <button onclick="testEcho()">ï¿½ ì—ì½” í…ŒìŠ¤íŠ¸</button>
                <button onclick="testBandwidth()">ğŸ“Š ëŒ€ì—­í­ í…ŒìŠ¤íŠ¸</button>
                <button onclick="simulateNetworkIssue()">ğŸŒ ë„¤íŠ¸ì›Œí¬ ì´ìŠˆ ì‹œë®¬ë ˆì´ì…˜</button>
                <button onclick="recordSession()">ğŸ¬ ì„¸ì…˜ ë…¹í™”</button>
                <button onclick="shareScreen()">ğŸ–¥ï¸ í™”ë©´ ê³µìœ </button>
            </div>
            
            <!-- í…ŒìŠ¤íŠ¸ ê²°ê³¼ -->
            <div id="testResults" style="display: none;" class="success-message">
                <h4>ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼</h4>
                <div id="testResultContent"></div>
            </div>
        </div>

        <!-- 6. ì‹¤ì‹œê°„ ë¡œê·¸ -->
        <div class="section">
            <h3>ğŸ“ ì‹¤ì‹œê°„ ë¡œê·¸ ë° ë””ë²„ê¹…</h3>
            <div class="quick-actions">
                <button onclick="clearLog()">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
                <button onclick="exportLog()">ğŸ’¾ ë¡œê·¸ ë‚´ë³´ë‚´ê¸°</button>
                <button onclick="toggleDebugMode()" id="debugBtn">ğŸ› ë””ë²„ê·¸ ëª¨ë“œ</button>
            </div>
            <div id="log"></div>
        </div>

        <!-- 7. ë°© ëª©ë¡ -->
        <div id="roomListSection" class="section" style="display: none;">
            <h3>ğŸ“‹ í™œì„± ë°© ëª©ë¡</h3>
            <div id="roomListContainer"></div>
            <button onclick="refreshRoomList()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let socket = null;
        let localStream = null;
        let peerConnections = new Map(); // ë‹¤ì¤‘ ì—°ê²° ì§€ì›
        let currentRoomCode = null;
        let sessionId = null;
        let guestUserId = null;
        let isDebugMode = false;
        let connectionStats = {
            latency: 0,
            packetLoss: 0,
            bandwidth: 0
        };
        let mediaConstraints = {
            video: { width: 640, height: 480 },
            audio: true
        };

        // ì±„íŒ… ê´€ë ¨ ë³€ìˆ˜
        let chatSettings = {
            showTimestamp: true,
            soundNotification: true,
            autoScroll: true
        };
        let unreadCount = 0;

        // UUID ìƒì„± (ë” ê°•ë ¥í•œ ë²„ì „)
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // í–¥ìƒëœ ë¡œê·¸ í•¨ìˆ˜
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': '#e2e8f0',
                'success': '#68d391',
                'error': '#fc8181',
                'warning': '#f6e05e',
                'debug': '#90cdf4'
            };
            
            const coloredMessage = `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span>`;
            logElement.innerHTML += coloredMessage + '\n';
            logElement.scrollTop = logElement.scrollHeight;
            
            if (isDebugMode) {
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.', 'info');
        }

        function exportLog() {
            const logContent = document.getElementById('log').textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `webrtc-test-log-${new Date().toISOString().slice(0,19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('ë¡œê·¸ë¥¼ íŒŒì¼ë¡œ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.', 'success');
        }

        function toggleDebugMode() {
            isDebugMode = !isDebugMode;
            const debugBtn = document.getElementById('debugBtn');
            debugBtn.textContent = isDebugMode ? 'ğŸ› ë””ë²„ê·¸ OFF' : 'ğŸ› ë””ë²„ê·¸ ON';
            log(`ë””ë²„ê·¸ ëª¨ë“œ: ${isDebugMode ? 'ON' : 'OFF'}`, 'info');
        }

        // ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ 
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = `âŒ ${message}`;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.main-grid'));
            setTimeout(() => errorDiv.remove(), 5000);
            log(message, 'error');
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = `âœ… ${message}`;
            document.querySelector('.container').insertBefore(successDiv, document.querySelector('.main-grid'));
            setTimeout(() => successDiv.remove(), 3000);
            log(message, 'success');
        }

        // ì„¸ì…˜ í™•ì¸ í•¨ìˆ˜
        async function checkSession() {
            try {
                log('ğŸª ì„¸ì…˜ ì •ë³´ í™•ì¸ ì¤‘...', 'info');
                
                // ë¨¼ì € ì„¸ì…˜ ì´ˆê¸°í™”
                await fetch('http://localhost:8889/init-session', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                // ì„¸ì…˜ ì •ë³´ ì¡°íšŒ
                const response = await fetch('http://localhost:8889/session-info', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                const sessionData = await response.json();
                
                if (response.ok) {
                    displaySessionInfo(sessionData);
                    log('âœ… ì„¸ì…˜ ì •ë³´ ì¡°íšŒ ì„±ê³µ', 'success');
                } else {
                    throw new Error('ì„¸ì…˜ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
                }
                
            } catch (error) {
                log(`âŒ ì„¸ì…˜ í™•ì¸ ì˜¤ë¥˜: ${error.message}`, 'error');
                showError(`ì„¸ì…˜ í™•ì¸ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        function displaySessionInfo(sessionData) {
            const sessionInfoElement = document.getElementById('sessionInfo');
            const sessionDetailsElement = document.getElementById('sessionDetails');
            
            sessionDetailsElement.innerHTML = `
                <div style="text-align: left; font-size: 0.9em;">
                    <p><strong>ì„¸ì…˜ ID:</strong> <code>${sessionData.sessionID}</code></p>
                    <p><strong>ì¸ì¦ ìƒíƒœ:</strong> ${sessionData.isAuthenticated ? 'âœ… ì¸ì¦ë¨' : 'âŒ ë¯¸ì¸ì¦'}</p>
                    <p><strong>ì„œë²„ ì¿ í‚¤:</strong> <code>${sessionData.cookies || 'ì—†ìŒ'}</code></p>
                    <p><strong>ì„¸ì…˜ ë°ì´í„°:</strong> <pre style="font-size: 0.8em; background: #f4f4f4; padding: 10px; border-radius: 4px;">${JSON.stringify(sessionData.session, null, 2)}</pre></p>
                    <p><strong>íƒ€ì„ìŠ¤íƒ¬í”„:</strong> ${new Date(sessionData.timestamp).toLocaleString()}</p>
                </div>
            `;
            
            sessionInfoElement.style.display = 'block';
            
            // í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì •ë³´
            sessionDetailsElement.innerHTML += `
                <hr style="margin: 15px 0;">
                <p><strong>í´ë¼ì´ì–¸íŠ¸ ì •ë³´:</strong></p>
                <p><strong>User Agent:</strong> <small>${navigator.userAgent}</small></p>
                <p><strong>ì¿ í‚¤ ì •ì±…:</strong> ${navigator.cookieEnabled ? 'âœ… í™œì„±í™”' : 'âŒ ë¹„í™œì„±í™”'}</p>
                <p><strong>HTTPS:</strong> ${location.protocol === 'https:' ? 'âœ…' : 'âŒ (HTTP)'}</p>
            `;
        }

        // ì„œë²„ ì—°ê²° (ê°œì„ ëœ ë²„ì „)
        function connectToServer() {
            log('ì„œë²„ ì—°ê²° ì‹œë„ ì¤‘...', 'info');
            
            socket = io('http://localhost:8889', {
                transports: ['websocket', 'polling'],
                timeout: 5000,
                forceNew: true
            });
            
            socket.on('connect', () => {
                log('âœ… ì„œë²„ì— ì„±ê³µì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                updateConnectionStatus(true);
                sessionId = socket.id; // Socket.IO ì„¸ì…˜ ID ì‚¬ìš©
            });

            socket.on('disconnect', (reason) => {
                log(`âŒ ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì´ìœ : ${reason}`, 'error');
                updateConnectionStatus(false);
                resetAllConnections();
                // ì±„íŒ… ê¸°ëŠ¥ ë¹„í™œì„±í™”
                enableChatFeatures(false);
            });

            socket.on('connect_error', (error) => {
                log(`âŒ ì—°ê²° ì˜¤ë¥˜: ${error.message}`, 'error');
                updateConnectionStatus(false);
            });

            // Socket.IO ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
            socket.on('joined-room-success', (data) => {
                log(`ğŸ‰ ë°© ì°¸ì—¬ ì„±ê³µ: ${JSON.stringify(data)}`, 'success');
                currentRoomCode = data.roomCode;
                guestUserId = data.guestUserId || generateUUID();
                
                enableWebRTCControls(true);
                updateRoomInfo(data);
                showSuccess('ë°©ì— ì„±ê³µì ìœ¼ë¡œ ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤!');
            });

            socket.on('join-room-error', (data) => {
                log(`âŒ ë°© ì°¸ì—¬ ì‹¤íŒ¨: ${data.message}`, 'error');
                showError(`ë°© ì°¸ì—¬ ì‹¤íŒ¨: ${data.message}`);
            });

            socket.on('room-users', (users) => {
                log(`ğŸ‘¥ ë°© ì°¸ì—¬ì ì—…ë°ì´íŠ¸: ${users.length}ëª…`, 'info');
                updateParticipants(users);
                
                // WebRTC ì—°ê²°ì´ í™œì„±í™”ëœ ê²½ìš° ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ê³¼ ì—°ê²°
                if (localStream && document.getElementById('connectBtn').disabled) {
                    users.forEach(user => {
                        if (user.socketId !== socket.id && !peerConnections.has(user.socketId)) {
                            log(`ğŸ”— WebRTC ì—°ê²° ì‹œë„: ${user.nickname}`, 'info');
                            initiateWebRTCConnection(user.socketId);
                        }
                    });
                }
            });

            socket.on('user-joined', (data) => {
                log(`ğŸ‘‹ ìƒˆ ì‚¬ìš©ì ì°¸ì—¬: ${data.nickname} (${data.socketId})`, 'info');
                // ìƒˆ ì‚¬ìš©ìì™€ WebRTC ì—°ê²° ì‹œì‘
                if (localStream && data.socketId !== socket.id) {
                    setTimeout(() => {
                        initiateWebRTCConnection(data.socketId);
                    }, 1000); // 1ì´ˆ í›„ ì—°ê²° ì‹œì‘
                }
            });

            socket.on('user-left', (data) => {
                log(`ğŸ‘‹ ì‚¬ìš©ì ë‚˜ê°: ${data.nickname}`, 'info');
                closePeerConnection(data.socketId);
            });

            // ì±„íŒ… ë©”ì‹œì§€ ìˆ˜ì‹ 
            socket.on('chat-message', (data) => {
                log(`ğŸ’¬ ì±„íŒ… ë©”ì‹œì§€ ìˆ˜ì‹ : ${data.senderNickname}`, 'debug');
                addChatMessage(data.senderNickname, data.message, false);
            });

            // WebRTC ì‹œê·¸ë„ë§ ì´ë²¤íŠ¸ë“¤
            socket.on('offer', (data) => {
                log(`ğŸ“ Offer ìˆ˜ì‹  from ${data.fromNickname}`, 'debug');
                handleReceiveOffer(data);
            });

            socket.on('answer', (data) => {
                log(`ğŸ“ Answer ìˆ˜ì‹  from ${data.fromNickname}`, 'debug');
                handleReceiveAnswer(data);
            });

            socket.on('ice-candidate', (data) => {
                log(`ğŸ§Š ICE Candidate ìˆ˜ì‹ `, 'debug');
                handleReceiveIceCandidate(data);
            });

            socket.on('error', (error) => {
                log(`âŒ Socket ì—ëŸ¬: ${error.message}`, 'error');
                showError(error.message);
            });
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.className = 'status connected';
                statusElement.innerHTML = 'ğŸŸ¢ ì„œë²„ì— ì—°ê²°ë¨ <small>(ì‹¤ì‹œê°„ í†µì‹  ê°€ëŠ¥)</small>';
            } else {
                statusElement.className = 'status disconnected';
                statusElement.innerHTML = 'ğŸ”´ ì„œë²„ ì—°ê²° ì•ˆë¨ <small>(ì¬ì—°ê²° ì‹œë„ ì¤‘...)</small>';
                setTimeout(() => {
                    if (!socket || !socket.connected) {
                        connectToServer();
                    }
                }, 3000); // 3ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„
            }
        }

        // ë°© ìƒì„± (ê°œì„ ëœ ë²„ì „)
        async function createRoom() {
            if (!sessionId) sessionId = generateUUID();
            
            const roomData = {
                roomName: document.getElementById('roomName').value || 'WebRTC í…ŒìŠ¤íŠ¸ ë°©',
                hostSessionId: sessionId,
                hostNickname: document.getElementById('hostNickname').value || 'ë°©ì¥',
                maxCapacity: parseInt(document.getElementById('maxCapacity').value)
            };

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!roomData.roomName.trim() || !roomData.hostNickname.trim()) {
                showError('ë°© ì´ë¦„ê³¼ ë‹‰ë„¤ì„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                log('ğŸ—ï¸ ë°© ìƒì„± ìš”ì²­ ì¤‘...', 'info');
                document.getElementById('createRoomBtn').disabled = true;
                
                const response = await fetch('http://localhost:8889/api/rooms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(roomData)
                });

                const result = await response.json();
                
                if (result.resultType === 'SUCCESS') {
                    const roomCode = result.success.roomCode;
                    log(`âœ… ë°© ìƒì„± ì„±ê³µ! ì½”ë“œ: ${roomCode}`, 'success');
                    
                    // UI ì—…ë°ì´íŠ¸
                    document.getElementById('joinRoomCode').value = roomCode;
                    guestUserId = result.success.hostGuestId;
                    
                    // ìë™ìœ¼ë¡œ WebSocket ë°© ì°¸ì—¬
                    if (socket && socket.connected) {
                        joinWebSocketRoom(roomCode, guestUserId, roomData.hostNickname);
                        // ì±„íŒ… ê¸°ëŠ¥ í™œì„±í™”
                        enableChatFeatures(true);
                    } else {
                        showError('ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                    
                    showSuccess(`ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ì½”ë“œ: ${roomCode}`);
                } else {
                    throw new Error(result.error?.reason || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                }
            } catch (error) {
                log(`âŒ ë°© ìƒì„± ì˜¤ë¥˜: ${error.message}`, 'error');
                showError(`ë°© ìƒì„± ì‹¤íŒ¨: ${error.message}`);
            } finally {
                document.getElementById('createRoomBtn').disabled = false;
            }
        }

        // ë°© ì°¸ì—¬ (ê°œì„ ëœ ë²„ì „)
        async function joinRoom() {
            const roomCode = document.getElementById('joinRoomCode').value.trim().toUpperCase();
            const nickname = document.getElementById('guestNickname').value.trim();
            
            if (!roomCode) {
                showError('ë°© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!nickname) {
                showError('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!sessionId) sessionId = generateUUID();
            
            const joinData = {
                roomCode: roomCode,
                nickname: nickname
            };

            try {
                log('ğŸšª ë°© ì°¸ì—¬ ìš”ì²­ ì¤‘...', 'info');
                document.getElementById('joinRoomBtn').disabled = true;
                
                const response = await fetch('http://localhost:8889/api/rooms/join', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(joinData)
                });

                const result = await response.json();
                
                if (result.resultType === 'SUCCESS') {
                    log(`âœ… ë°© ì°¸ì—¬ ì„±ê³µ!`, 'success');
                    guestUserId = result.success.guestUserId;
                    
                    // WebSocket ë°© ì°¸ì—¬
                    if (socket && socket.connected) {
                        joinWebSocketRoom(roomCode, guestUserId, nickname);
                        // ì±„íŒ… ê¸°ëŠ¥ í™œì„±í™”
                        enableChatFeatures(true);
                    } else {
                        showError('ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    }
                } else {
                    throw new Error(result.error?.reason || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                }
            } catch (error) {
                log(`âŒ ë°© ì°¸ì—¬ ì˜¤ë¥˜: ${error.message}`, 'error');
                showError(`ë°© ì°¸ì—¬ ì‹¤íŒ¨: ${error.message}`);
            } finally {
                document.getElementById('joinRoomBtn').disabled = false;
            }
        }

        // WebSocket ë°© ì°¸ì—¬
        function joinWebSocketRoom(roomCode, guestUserId, nickname) {
            if (!socket || !socket.connected) {
                showError('ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            socket.emit('join-room', {
                roomCode: roomCode,
                guestUserId: guestUserId,
                nickname: nickname
            });

            log(`ğŸ”Œ WebSocket ë°© ì°¸ì—¬ ìš”ì²­: ${roomCode}`, 'info');
        }

        // ë°© ë‚˜ê°€ê¸°
        function leaveRoom() {
            if (socket && currentRoomCode) {
                socket.emit('leave-room');
                log('ğŸšª ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.', 'info');
                
                resetRoomState();
                showSuccess('ë°©ì—ì„œ ë‚˜ì™”ìŠµë‹ˆë‹¤.');
            }
        }

        function resetRoomState() {
            currentRoomCode = null;
            guestUserId = null;
            enableWebRTCControls(false);
            hideRoomInfo();
            resetAllConnections();
        }

        // ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        function testQuickJoin() {
            // í˜„ì¬ ìƒì„±ëœ ë°©ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì°¸ì—¬
            const roomCode = document.getElementById('joinRoomCode').value;
            if (roomCode) {
                document.getElementById('guestNickname').value = `í…ŒìŠ¤í„°${Math.floor(Math.random() * 1000)}`;
                joinRoom();
            } else {
                showError('ë¨¼ì € ë°©ì„ ìƒì„±í•˜ê±°ë‚˜ ë°© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        }

        // í–¥ìƒëœ ë¹„ë””ì˜¤ í•¨ìˆ˜ë“¤
        async function startLocalVideo() {
            try {
                log('ğŸ“¹ ë¯¸ë””ì–´ ì ‘ê·¼ ê¶Œí•œ ìš”ì²­ ì¤‘...', 'info');
                
                localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints);
                
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = localStream;
                
                // í•´ìƒë„ ì •ë³´ ì—…ë°ì´íŠ¸
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    const settings = videoTrack.getSettings();
                    document.getElementById('localResolution').textContent = 
                        `${settings.width}x${settings.height}`;
                }
                
                updateMediaControls(true);
                log('âœ… ë¡œì»¬ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                
                // WebRTC ì—°ê²° ë²„íŠ¼ í™œì„±í™” (ë°©ì— ì°¸ì—¬í•œ ê²½ìš°)
                if (currentRoomCode) {
                    document.getElementById('connectBtn').disabled = false;
                }
                
            } catch (error) {
                log(`âŒ ë¯¸ë””ì–´ ì ‘ê·¼ ì‹¤íŒ¨: ${error.message}`, 'error');
                showError(`ë¯¸ë””ì–´ ì ‘ê·¼ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        function stopLocalVideo() {
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    track.stop();
                    log(`íŠ¸ë™ ì¤‘ì§€: ${track.kind}`, 'debug');
                });
                localStream = null;
                
                document.getElementById('localVideo').srcObject = null;
                document.getElementById('localResolution').textContent = '-';
                
                updateMediaControls(false);
                log('â¹ï¸ ë¡œì»¬ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                
                // ëª¨ë“  WebRTC ì—°ê²° í•´ì œ
                resetAllConnections();
            }
        }

        function updateMediaControls(hasMedia) {
            document.getElementById('startVideoBtn').disabled = hasMedia;
            document.getElementById('stopVideoBtn').disabled = !hasMedia;
            document.getElementById('toggleAudioBtn').disabled = !hasMedia;
            document.getElementById('toggleVideoBtn').disabled = !hasMedia;
        }

        function enableWebRTCControls(enabled) {
            document.getElementById('leaveBtn').disabled = !enabled;
            document.getElementById('connectBtn').disabled = !enabled || !localStream;
            document.getElementById('disconnectBtn').disabled = !enabled;
            document.getElementById('restartBtn').disabled = !enabled;
        }

        // ì˜¤ë””ì˜¤/ë¹„ë””ì˜¤ í† ê¸€ ê¸°ëŠ¥
        function toggleAudio() {
            if (!localStream) return;
            
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                const btn = document.getElementById('toggleAudioBtn');
                btn.textContent = audioTrack.enabled ? 'ğŸ¤ ìŒì†Œê±°' : 'ğŸ”‡ ìŒì†Œê±° í•´ì œ';
                log(`ìŒì„± ${audioTrack.enabled ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}`, 'info');
            }
        }

        function toggleVideo() {
            if (!localStream) return;
            
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                const btn = document.getElementById('toggleVideoBtn');
                btn.textContent = videoTrack.enabled ? 'ğŸ“· ë¹„ë””ì˜¤ ë„ê¸°' : 'ğŸ“¹ ë¹„ë””ì˜¤ ì¼œê¸°';
                log(`ë¹„ë””ì˜¤ ${videoTrack.enabled ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}`, 'info');
            }
        }

        function updateVolume() {
            const volume = document.getElementById('volumeSlider').value;
            document.getElementById('volumeValue').textContent = volume;
            
            const remoteVideo = document.getElementById('remoteVideo');
            if (remoteVideo) {
                remoteVideo.volume = volume / 100;
            }
        }

        // WebRTC ì—°ê²° í•¨ìˆ˜ë“¤ (ë‹¤ì¤‘ ì—°ê²° ì§€ì›)
        async function connectToRoom() {
            if (!localStream) {
                showError('ë¨¼ì € ë¹„ë””ì˜¤ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!currentRoomCode) {
                showError('ë°©ì— ë¨¼ì € ì°¸ì—¬í•´ì£¼ì„¸ìš”.');
                return;
            }

            log('ğŸ”— WebRTC ì—°ê²° ì‹œì‘...', 'info');
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;
            
            // ë°©ì˜ í˜„ì¬ ì°¸ì—¬ìë“¤ê³¼ ì—°ê²°
            if (socket) {
                socket.emit('request-room-users', { roomCode: currentRoomCode });
            }
            
            showSuccess('WebRTC ì—°ê²°ì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.');
        }

        function createPeerConnection(targetSocketId) {
            const pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ],
                iceCandidatePoolSize: 10
            });

            // ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ ì¶”ê°€
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
            }

            // ì›ê²© ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬
            pc.ontrack = (event) => {
                log('ğŸ“º ì›ê²© ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹ ë¨', 'success');
                const remoteVideo = document.getElementById('remoteVideo');
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                    
                    // í•´ìƒë„ ì •ë³´ ì—…ë°ì´íŠ¸
                    const videoTrack = event.streams[0].getVideoTracks()[0];
                    if (videoTrack) {
                        videoTrack.onended = () => {
                            document.getElementById('remoteResolution').textContent = '-';
                        };
                    }
                }
            };

            // ICE Candidate ì²˜ë¦¬
            pc.onicecandidate = (event) => {
                if (event.candidate && socket) {
                    socket.emit('ice-candidate', {
                        candidate: event.candidate,
                        targetSocketId: targetSocketId
                    });
                    log('ğŸ§Š ICE Candidate ì „ì†¡ë¨', 'debug');
                }
            };

            // ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
            pc.onconnectionstatechange = () => {
                log(`WebRTC ì—°ê²° ìƒíƒœ: ${pc.connectionState}`, 'info');
                updateConnectionQuality(pc);
                
                if (pc.connectionState === 'connected') {
                    showSuccess('WebRTC ì—°ê²°ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!');
                    startStatsMonitoring(pc);
                } else if (pc.connectionState === 'failed') {
                    showError('WebRTC ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            };

            peerConnections.set(targetSocketId, pc);
            return pc;
        }

        async function initiateWebRTCConnection(targetSocketId) {
            try {
                const pc = createPeerConnection(targetSocketId);
                
                const offer = await pc.createOffer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: true
                });
                
                await pc.setLocalDescription(offer);
                
                socket.emit('offer', {
                    offer: offer,
                    targetSocketId: targetSocketId
                });
                
                log(`ğŸ“ Offer ì „ì†¡ë¨ to ${targetSocketId}`, 'debug');
            } catch (error) {
                log(`âŒ Offer ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // WebRTC ì‹œê·¸ë„ë§ ì²˜ë¦¬
        async function handleReceiveOffer(data) {
            try {
                const pc = createPeerConnection(data.fromSocketId);
                
                await pc.setRemoteDescription(data.offer);
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                
                socket.emit('answer', {
                    answer: answer,
                    targetSocketId: data.fromSocketId
                });
                
                log(`ğŸ“ Answer ì „ì†¡ë¨ to ${data.fromNickname}`, 'debug');
            } catch (error) {
                log(`âŒ Offer ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function handleReceiveAnswer(data) {
            const pc = peerConnections.get(data.fromSocketId);
            if (!pc) return;
            
            try {
                await pc.setRemoteDescription(data.answer);
                log(`âœ… Answer ì²˜ë¦¬ ì™„ë£Œ from ${data.fromNickname}`, 'debug');
            } catch (error) {
                log(`âŒ Answer ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function handleReceiveIceCandidate(data) {
            const pc = peerConnections.get(data.fromSocketId);
            if (!pc) return;
            
            try {
                await pc.addIceCandidate(data.candidate);
                log('ğŸ§Š ICE Candidate ì¶”ê°€ ì™„ë£Œ', 'debug');
            } catch (error) {
                log(`âŒ ICE Candidate ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        function closePeerConnection(socketId) {
            const pc = peerConnections.get(socketId);
            if (pc) {
                pc.close();
                peerConnections.delete(socketId);
                log(`WebRTC ì—°ê²° ì¢…ë£Œ: ${socketId}`, 'info');
            }
        }

        function resetAllConnections() {
            peerConnections.forEach((pc, socketId) => {
                pc.close();
            });
            peerConnections.clear();
            
            const remoteVideo = document.getElementById('remoteVideo');
            remoteVideo.srcObject = null;
            document.getElementById('remoteResolution').textContent = '-';
            
            updateConnectionQuality(null);
            log('ëª¨ë“  WebRTC ì—°ê²°ì´ ì¬ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }

        function disconnectWebRTC() {
            resetAllConnections();
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            // ì±„íŒ… ê¸°ëŠ¥ ë¹„í™œì„±í™”
            enableChatFeatures(false);
            showSuccess('WebRTC ì—°ê²°ì„ í•´ì œí–ˆìŠµë‹ˆë‹¤.');
        }

        function restartConnection() {
            disconnectWebRTC();
            setTimeout(() => {
                if (currentRoomCode && localStream) {
                    connectToRoom();
                }
            }, 1000);
        }

        // ì—°ê²° í’ˆì§ˆ ëª¨ë‹ˆí„°ë§
        function updateConnectionQuality(pc) {
            if (!pc) {
                document.getElementById('latency').textContent = '-';
                document.getElementById('packetLoss').textContent = '-';
                document.getElementById('bandwidth').textContent = '-';
                return;
            }

            // WebRTC í†µê³„ ìˆ˜ì§‘ì€ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬
            setInterval(() => {
                if (pc.connectionState === 'connected') {
                    getConnectionStats(pc);
                }
            }, 2000);
        }

        async function getConnectionStats(pc) {
            try {
                const stats = await pc.getStats();
                let latency = 0, packetLoss = 0, bandwidth = 0;
                
                stats.forEach(report => {
                    if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                        latency = report.currentRoundTripTime ? Math.round(report.currentRoundTripTime * 1000) : 0;
                    }
                    if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                        packetLoss = report.packetsLost || 0;
                        bandwidth = Math.round((report.bytesReceived * 8) / 1000) || 0;
                    }
                });

                document.getElementById('latency').textContent = latency;
                document.getElementById('packetLoss').textContent = packetLoss;
                document.getElementById('bandwidth').textContent = bandwidth;
                
                connectionStats = { latency, packetLoss, bandwidth };
            } catch (error) {
                log(`í†µê³„ ìˆ˜ì§‘ ì˜¤ë¥˜: ${error.message}`, 'debug');
            }
        }

        function startStatsMonitoring(pc) {
            log('ğŸ“Š ì—°ê²° í’ˆì§ˆ ëª¨ë‹ˆí„°ë§ ì‹œì‘', 'info');
            // ì´ë¯¸ updateConnectionQualityì—ì„œ ì²˜ë¦¬ë¨
        }

        // ë°© ì •ë³´ ì—…ë°ì´íŠ¸
        function updateRoomInfo(roomData) {
            const roomInfoElement = document.getElementById('roomInfo');
            const roomDetailsElement = document.getElementById('roomDetails');
            
            roomDetailsElement.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div><strong>ğŸ  ë°© ì½”ë“œ:</strong> <span style="font-size: 1.2em; color: #007bff;">${roomData.roomCode || currentRoomCode}</span></div>
                    <div><strong>ğŸ“ ë°© ì´ë¦„:</strong> ${roomData.roomName || 'ì•Œ ìˆ˜ ì—†ìŒ'}</div>
                    <div><strong>ğŸ‘¥ í˜„ì¬ ì¸ì›:</strong> ${roomData.currentCapacity || 1}/${roomData.maxCapacity || 4}</div>
                    <div><strong>ğŸ“Š ìƒíƒœ:</strong> <span style="color: #28a745;">${roomData.roomState || 'waiting'}</span></div>
                </div>
            `;
            
            roomInfoElement.style.display = 'block';
        }

        function refreshRoomInfo() {
            if (!currentRoomCode) return;
            
            fetch(`http://localhost:8889/api/rooms/${currentRoomCode}`)
                .then(response => response.json())
                .then(result => {
                    if (result.resultType === 'SUCCESS') {
                        updateRoomInfo(result.success);
                        updateParticipants(result.success.participants);
                        log('ë°© ì •ë³´ê°€ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    }
                })
                .catch(error => {
                    log(`ë°© ì •ë³´ ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜: ${error.message}`, 'error');
                });
        }

        function copyRoomCode() {
            if (!currentRoomCode) return;
            
            navigator.clipboard.writeText(currentRoomCode).then(() => {
                showSuccess('ë°© ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(err => {
                log(`í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨: ${err}`, 'error');
            });
        }

        // ì°¸ì—¬ì ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateParticipants(participants) {
            const participantsElement = document.getElementById('participantsInfo');
            const participantsListElement = document.getElementById('participantsList');
            const participantCountElement = document.getElementById('participantCount');
            
            if (participants && participants.length > 0) {
                participantCountElement.textContent = participants.length;
                
                participantsListElement.innerHTML = participants.map(p => `
                    <div class="participant">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${p.nickname}</strong> 
                                <span style="background: ${p.role === 'host' ? '#ff6b6b' : '#4ecdc4'}; 
                                            color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                                    ${p.role === 'host' ? 'ğŸ‘‘ ë°©ì¥' : 'ğŸ‘¤ ì°¸ì—¬ì'}
                                </span>
                            </div>
                            <small style="color: #666;">
                                ${new Date(p.joinedAt).toLocaleTimeString()}
                            </small>
                        </div>
                        ${p.preparationStatus ? `
                            <div style="margin-top: 8px; font-size: 0.9em;">
                                <span style="color: ${p.preparationStatus.characterSetup ? '#28a745' : '#dc3545'};">
                                    ${p.preparationStatus.characterSetup ? 'âœ…' : 'âŒ'} ìºë¦­í„° ì„¤ì •
                                </span>
                                <span style="margin-left: 15px; color: ${p.preparationStatus.screenSetup ? '#28a745' : '#dc3545'};">
                                    ${p.preparationStatus.screenSetup ? 'âœ…' : 'âŒ'} í™”ë©´ ì„¤ì •
                                </span>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
                
                participantsElement.style.display = 'block';
            } else {
                participantsElement.style.display = 'none';
            }
        }

        function hideRoomInfo() {
            document.getElementById('roomInfo').style.display = 'none';
            document.getElementById('participantsInfo').style.display = 'none';
        }

        // ë°© ëª©ë¡ ì¡°íšŒ
        async function getRoomList() {
            try {
                log('ğŸ“‹ ë°© ëª©ë¡ ì¡°íšŒ ì¤‘...', 'info');
                
                const response = await fetch('http://localhost:8889/api/rooms?page=1&limit=20');
                const result = await response.json();
                
                if (result.resultType === 'SUCCESS') {
                    displayRoomList(result.success.rooms);
                    document.getElementById('roomListSection').style.display = 'block';
                    log(`ë°© ëª©ë¡ ì¡°íšŒ ì™„ë£Œ: ${result.success.totalCount}ê°œ ë°©`, 'success');
                } else {
                    throw new Error(result.error?.reason || 'ë°© ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
                }
            } catch (error) {
                log(`ë°© ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜: ${error.message}`, 'error');
                showError(`ë°© ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        function displayRoomList(rooms) {
            const container = document.getElementById('roomListContainer');
            
            if (!rooms || rooms.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">í˜„ì¬ í™œì„± ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            container.innerHTML = rooms.map(room => `
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0; color: #333;">${room.roomName}</h4>
                            <p style="margin: 5px 0; color: #666;">
                                ì½”ë“œ: <strong>${room.roomCode}</strong> | 
                                ì¸ì›: ${room.currentCapacity}/${room.maxCapacity} |
                                ìƒíƒœ: ${room.roomState}
                            </p>
                            <small style="color: #999;">
                                ë°©ì¥: ${room.hostGuest?.nickname || 'ì•Œ ìˆ˜ ì—†ìŒ'} | 
                                ìƒì„±: ${new Date(room.createdAt).toLocaleString()}
                            </small>
                        </div>
                        <button onclick="quickJoinRoom('${room.roomCode}')" 
                                ${room.currentCapacity >= room.maxCapacity ? 'disabled' : ''}>
                            ${room.currentCapacity >= room.maxCapacity ? 'ë§Œì„' : 'ì°¸ì—¬'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function quickJoinRoom(roomCode) {
            document.getElementById('joinRoomCode').value = roomCode;
            document.getElementById('guestNickname').value = `ê²ŒìŠ¤íŠ¸${Math.floor(Math.random() * 1000)}`;
            joinRoom();
        }

        function refreshRoomList() {
            getRoomList();
        }

        // ê³ ê¸‰ í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ë“¤
        async function testEcho() {
            log('ğŸ”Š ì—ì½” í…ŒìŠ¤íŠ¸ ì‹œì‘...', 'info');
            showTestResult('ì—ì½” í…ŒìŠ¤íŠ¸', 'ìŒì„± ì…ë ¥ê³¼ ì¶œë ¥ì„ í™•ì¸í•©ë‹ˆë‹¤.');
            
            // ê°„ë‹¨í•œ ìŒì„± ë ˆë²¨ ì²´í¬
            if (localStream) {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(localStream);
                const analyser = audioContext.createAnalyser();
                source.connect(analyser);
                
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(dataArray);
                
                const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                showTestResult('ì—ì½” í…ŒìŠ¤íŠ¸', `í‰ê·  ìŒì„± ë ˆë²¨: ${Math.round(average)}/255`);
            }
        }

        async function testBandwidth() {
            log('ğŸ“Š ëŒ€ì—­í­ í…ŒìŠ¤íŠ¸ ì‹œì‘...', 'info');
            showTestResult('ëŒ€ì—­í­ í…ŒìŠ¤íŠ¸', 'ë„¤íŠ¸ì›Œí¬ ì„±ëŠ¥ì„ ì¸¡ì • ì¤‘...');
            
            // í˜„ì¬ ì—°ê²° ìƒíƒœì—ì„œ í†µê³„ ì •ë³´ í‘œì‹œ
            setTimeout(() => {
                showTestResult('ëŒ€ì—­í­ í…ŒìŠ¤íŠ¸', 
                    `ì§€ì—°ì‹œê°„: ${connectionStats.latency}ms, íŒ¨í‚·ì†ì‹¤: ${connectionStats.packetLoss}, ëŒ€ì—­í­: ${connectionStats.bandwidth}kbps`);
            }, 2000);
        }

        function simulateNetworkIssue() {
            log('ğŸŒ ë„¤íŠ¸ì›Œí¬ ì´ìŠˆ ì‹œë®¬ë ˆì´ì…˜...', 'warning');
            showTestResult('ë„¤íŠ¸ì›Œí¬ í…ŒìŠ¤íŠ¸', 'ì¸ìœ„ì ì¸ ì§€ì—°ê³¼ íŒ¨í‚· ì†ì‹¤ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.');
            
            // ì‹¤ì œë¡œëŠ” WebRTC ì„¤ì •ì—ì„œ ë„¤íŠ¸ì›Œí¬ ì¡°ê±´ì„ ë³€ê²½í•´ì•¼ í•¨
            setTimeout(() => {
                showTestResult('ë„¤íŠ¸ì›Œí¬ í…ŒìŠ¤íŠ¸', 'ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ. ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.');
            }, 3000);
        }

        async function recordSession() {
            if (!localStream) {
                showError('ë…¹í™”í•˜ë ¤ë©´ ë¨¼ì € ë¯¸ë””ì–´ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            log('ğŸ¬ ì„¸ì…˜ ë…¹í™” ì‹œì‘...', 'info');
            showTestResult('ì„¸ì…˜ ë…¹í™”', 'ë¸Œë¼ìš°ì € ë…¹í™” ê¸°ëŠ¥ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
            
            try {
                const mediaRecorder = new MediaRecorder(localStream);
                const chunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    chunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `session-${Date.now()}.webm`;
                    a.click();
                    showTestResult('ì„¸ì…˜ ë…¹í™”', 'ë…¹í™” ì™„ë£Œ! íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.');
                };
                
                mediaRecorder.start();
                setTimeout(() => mediaRecorder.stop(), 5000); // 5ì´ˆ ë…¹í™”
                
            } catch (error) {
                showError(`ë…¹í™” ì‹¤íŒ¨: ${error.message}`);
            }
        }

        async function shareScreen() {
            try {
                log('ğŸ–¥ï¸ í™”ë©´ ê³µìœ  ì‹œì‘...', 'info');
                
                const screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: true, 
                    audio: true 
                });
                
                // ë¡œì»¬ ë¹„ë””ì˜¤ë¥¼ í™”ë©´ ê³µìœ ë¡œ êµì²´
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = screenStream;
                
                // ê¸°ì¡´ ì—°ê²°ì´ ìˆë‹¤ë©´ íŠ¸ë™ êµì²´
                peerConnections.forEach(pc => {
                    const sender = pc.getSenders().find(s => 
                        s.track && s.track.kind === 'video'
                    );
                    if (sender) {
                        sender.replaceTrack(screenStream.getVideoTracks()[0]);
                    }
                });
                
                showTestResult('í™”ë©´ ê³µìœ ', 'í™”ë©´ ê³µìœ ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
                
                // í™”ë©´ ê³µìœ  ì¤‘ë‹¨ ì‹œ ì›ë˜ ì¹´ë©”ë¼ë¡œ ë³µì›
                screenStream.getVideoTracks()[0].onended = () => {
                    if (localStream) {
                        localVideo.srcObject = localStream;
                        log('í™”ë©´ ê³µìœ ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                    }
                };
                
            } catch (error) {
                showError(`í™”ë©´ ê³µìœ  ì‹¤íŒ¨: ${error.message}`);
            }
        }

        function showTestResult(testName, result) {
            const resultDiv = document.getElementById('testResults');
            const contentDiv = document.getElementById('testResultContent');
            
            contentDiv.innerHTML = `<strong>${testName}:</strong> ${result}`;
            resultDiv.style.display = 'block';
            
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 5000);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            log('ğŸš€ GameCast WebRTC ê³ ê¸‰ í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ ì‹œì‘', 'success');
            log('ë¸Œë¼ìš°ì € ì§€ì› ê¸°ëŠ¥ í™•ì¸ ì¤‘...', 'info');
            
            // WebRTC ì§€ì› í™•ì¸
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError('ì´ ë¸Œë¼ìš°ì €ëŠ” WebRTCë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!window.RTCPeerConnection) {
                showError('ì´ ë¸Œë¼ìš°ì €ëŠ” RTCPeerConnectionì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            log('âœ… WebRTC ì§€ì› í™•ì¸ë¨', 'success');
            
            // ëœë¤ ë‹‰ë„¤ì„ ìƒì„±
            document.getElementById('guestNickname').value = `ì‚¬ìš©ì${Math.floor(Math.random() * 1000)}`;
            
            // ì„¸ì…˜ í™•ì¸
            checkSession();
            
            // ì„œë²„ ì—°ê²° ì‹œì‘
            connectToServer();
        };

        // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì •ë¦¬
        window.onbeforeunload = function() {
            log('í˜ì´ì§€ ì¢…ë£Œ - ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì¤‘...', 'info');
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            resetAllConnections();
            
            if (socket) {
                socket.disconnect();
            }
        };

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', function(event) {
            // Ctrl + Enter: ë¹ ë¥¸ ë°© ì°¸ì—¬
            if (event.ctrlKey && event.key === 'Enter') {
                event.preventDefault();
                const roomCode = document.getElementById('joinRoomCode').value;
                if (roomCode) {
                    joinRoom();
                } else {
                    createRoom();
                }
            }
            
            // F5 ì°¨ë‹¨í•˜ê³  ë°© ì •ë³´ ìƒˆë¡œê³ ì¹¨
            if (event.key === 'F5') {
                event.preventDefault();
                refreshRoomInfo();
            }
        });

        // ë°© ì½”ë“œ ì…ë ¥ ì‹œ ìë™ ëŒ€ë¬¸ì ë³€í™˜
        document.getElementById('joinRoomCode').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });

        // ========== ì±„íŒ… ê¸°ëŠ¥ ==========
        
        // ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡
        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) {
                alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!socket || !currentRoomCode) {
                alert('ë°©ì— ì°¸ì—¬í•œ í›„ ì±„íŒ…ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡
            socket.emit('chat-message', {
                roomCode: currentRoomCode,
                message: message,
                timestamp: new Date().toISOString()
            });
            
            // ë‚´ ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì°½ì— ì¶”ê°€
            addChatMessage('ë‚˜', message, true);
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            chatInput.value = '';
        }
        
        // ì±„íŒ… ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€
        function addChatMessage(sender, message, isOwn = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = isOwn ? 'chat-message own' : 'chat-message';
            
            const timestamp = chatSettings.showTimestamp ? 
                new Date().toLocaleTimeString('ko-KR', { hour12: false }) : '';
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    <strong class="sender">${sender}:</strong>
                    <span class="text">${escapeHtml(message)}</span>
                    ${timestamp ? `<small class="timestamp">${timestamp}</small>` : ''}
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            
            // ìë™ ìŠ¤í¬ë¡¤
            if (chatSettings.autoScroll) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // ì•Œë¦¼ìŒ ì¬ìƒ (ë³¸ì¸ ë©”ì‹œì§€ê°€ ì•„ë‹Œ ê²½ìš°)
            if (!isOwn && chatSettings.soundNotification) {
                playNotificationSound();
            }
        }
        
        // ì±„íŒ… ì…ë ¥ ì‹œ ì—”í„°í‚¤ ì²˜ë¦¬
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }
        
        // ì±„íŒ…ì°½ ì§€ìš°ê¸°
        function clearChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div style="text-align: center; color: #666; padding: 20px;">
                    <p>ì±„íŒ…ì´ ì‹œì‘ë˜ë©´ ì—¬ê¸°ì— ë©”ì‹œì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    <p><small>ë°©ì— ì°¸ì—¬í•œ í›„ ì±„íŒ…ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small></p>
                </div>
            `;
        }
        
        // HTML ì´ìŠ¤ì¼€ì´í”„ (XSS ë°©ì§€)
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ì•Œë¦¼ìŒ ì¬ìƒ
        function playNotificationSound() {
            try {
                // Web Audio APIë¥¼ ì‚¬ìš©í•œ ê°„ë‹¨í•œ ì•Œë¦¼ìŒ
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (error) {
                console.warn('ì•Œë¦¼ìŒ ì¬ìƒ ì‹¤íŒ¨:', error);
            }
        }
        
        // ì±„íŒ… ì„¤ì • í† ê¸€ í•¨ìˆ˜ë“¤
        function toggleTimestamp() {
            chatSettings.showTimestamp = document.getElementById('showTimestamp').checked;
        }
        
        function toggleSoundNotification() {
            chatSettings.soundNotification = document.getElementById('soundNotification').checked;
        }
        
        function toggleAutoScroll() {
            chatSettings.autoScroll = document.getElementById('autoScroll').checked;
        }
        
        // ì±„íŒ… ê¸°ëŠ¥ í™œì„±í™”/ë¹„í™œì„±í™”
        function enableChatFeatures(enabled) {
            document.getElementById('chatInput').disabled = !enabled;
            document.getElementById('sendChatBtn').disabled = !enabled;
            
            if (enabled) {
                addChatMessage('ì‹œìŠ¤í…œ', 'ì±„íŒ…ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”!', false);
            }
        }
    </script>
    
    <style>
        /* ì±„íŒ… ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .chat-message {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 8px;
            background: #fff;
            border-left: 3px solid #007bff;
            animation: fadeInMessage 0.3s ease-in;
        }
        
        .chat-message.own {
            background: #e7f3ff;
            border-left-color: #28a745;
            margin-left: 20px;
        }
        
        .chat-message .sender {
            color: #007bff;
            font-size: 0.9em;
        }
        
        .chat-message.own .sender {
            color: #28a745;
        }
        
        .chat-message .text {
            color: #333;
            margin-left: 8px;
        }
        
        .chat-message .timestamp {
            float: right;
            color: #666;
            font-size: 0.8em;
        }
        
        @keyframes fadeInMessage {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ì±„íŒ… ì…ë ¥ì°½ í¬ì»¤ìŠ¤ ìŠ¤íƒ€ì¼ */
        #chatInput:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            outline: none;
        }
        
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
        #chatMessages::-webkit-scrollbar {
            width: 8px;
        }
        
        #chatMessages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        #chatMessages::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }
        
        #chatMessages::-webkit-scrollbar-thumb:hover {
            background: #999;
        }
    </style>

</body>
</html>
